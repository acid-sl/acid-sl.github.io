---
layout: post
title: "Redis集群"
description: ""
category: Redis
tags: [redis, 集群]
---
{% include JB/setup %}

#### Redis 集群的三种模式
主从复制模式， 哨兵（sentinel）模式，cluster模式

##### 主从复制模式
![alt_主从复制](/asset/images/redis_master_slave.webp)

优点： 
* 支持主从复制。读写分离， 读数据操作可以从slave数据库获取，写操作仍然通过master机器
* 分载master的读操作。
* Slave 同样可以接受其它 Slaves 的连接和同步请求，这样可以有效的分载 Master 的同步压力；
* Master Server 是以非阻塞的方式为 Slaves 提供服务。所以在 Master-Slave 同步期间，客户端仍然可以提交查询或修改请求；
* Slave Server 同样是以非阻塞的方式完成数据同步。在同步期间，如果有客户端提交查询请求，Redis则返回同步之前的数据
缺点：
* 不具备容灾以及数据恢复能力， 主从服务器宕机都会造成读写不一致，进而导致数据不一致。系统的可用性差。宕机后需要人工处理，重启服务。
* 比较难支持扩容。
* 多个slave同时断线后，最好不要同时启动。因为多台从主机会同时发送SYNC同步请求给到主服务器，全量同步数据，master机器的IO会剧增导致宕机


##### 哨兵模式

可以理解为主从复制的自动版， redis有个独立的进程，监控master的状态。 当master宕机后， 哨兵进程会通过发布订阅模式，通知其他slave， 并修改配置将其中的一台slave主机改为master主机。
一个哨兵进程也有可能断开， 所以哨兵模式一般采用多个哨兵进程监控redis服务。 哨兵进程会每个10S PING一次master机器，以及slave机器。如果一个哨兵监控到master主机Ping超时返回，会将该master标记为主观下线（SDOWN）
然后其他哨兵进程会每个1SPing一次master，当多数哨兵都监控到该主机下线，就会将该master标记为客观下线（ODOWN）


##### Cluster 集群主从模式

Redis 集群没有使用一致性 hash，而是引入了哈希槽【hash slot】的概念。

Redis 集群有16384 个哈希槽，每个 key 通过 CRC16 校验后对 16384 取模来决定放置哪个槽。集群的每个节点负责一部分hash槽，举个例子，比如当前集群有3个节点，那么：

节点 A 包含 0 到 5460 号哈希槽
节点 B 包含 5461 到 10922 号哈希槽
节点 C 包含 10923 到 16383 号哈希槽
这种结构很容易添加或者删除节点。比如如果我想新添加个节点 D ， 我需要从节点 A， B， C 中得部分槽到 D 上。如果我想移除节点 A ，需要将 A 中的槽移到 B 和 C 节点上，然后将没有任何槽的 A 节点从集群中移除即可。由于从一个节点将哈希槽移动到另一个节点并不会停止服务，所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态。

在 Redis 的每一个节点上，都有这么两个东西，一个是插槽（slot），它的的取值范围是：0-16383。还有一个就是 cluster，可以理解为是一个集群管理的插件。当我们的存取的 Key到达的时候，Redis 会根据 CRC16 的算法得出一个结果，然后把结果对 16384 求余数，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，通过这个值，去找到对应的插槽所对应的节点，然后直接自动跳转到这个对应的节点上进行存取操作。

Redis 集群的主从复制模型
为了保证高可用，redis-cluster集群引入了主从复制模型，一个主节点对应一个或者多个从节点，当主节点宕机的时候，就会启用从节点。当其它主节点 ping 一个主节点 A 时，如果半数以上的主节点与 A 通信超时，那么认为主节点 A 宕机了。如果主节点 A 和它的从节点 A1 都宕机了，那么该集群就无法再提供服务了。

集群的特点
所有的 redis 节点彼此互联(PING-PONG机制)，内部使用二进制协议优化传输速度和带宽。
节点的 fail 是通过集群中超过半数的节点检测失效时才生效。
客户端与 Redis 节点直连，不需要中间代理层.客户端不需要连接集群所有节点，连接集群中任何一个可用节点即可。



#### 实操
主要是写redis的配置文件，写完后挨个启动就可以。 

#####参考链接（侵删）：
[Redis三种集群模式](https://segmentfault.com/a/1190000022808576)